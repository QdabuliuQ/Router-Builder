#! /usr/bin/env node
global.navigator={userAgent:"node.js"};var fs=require("node:fs"),path=require("node:path"),prettier=require("prettier");function getDefaultExportFromCjs(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var styles={reset:"[0m",bright:"[1m",grey:"[2m",italic:"[3m",underline:"[4m",reverse:"[7m",hidden:"[8m",black:"[30m",red:"[31m",green:"[32m",yellow:"[33m",blue:"[34m",magenta:"[35m",cyan:"[36m",white:"[37m",blackBG:"[40m",redBG:"[41m",greenBG:"[42m",yellowBG:"[43m",blueBG:"[44m",magentaBG:"[45m",cyanBG:"[46m",whiteBG:"[47m"};function colors(e,t){var o="";return"string"==typeof e?o=styles[e]:e.forEach((e=>{o+=styles[e]})),o+t+styles.reset}var colorsConsole=colors,colors$1=getDefaultExportFromCjs(colorsConsole);const rootPath=process.cwd();function getFilesInfo(e){let t=fs.readdirSync(e);const o={};return t.forEach((function(t){const n=path.join(e,t),r=fs.statSync(n);o[t]={type:r.isFile()?"file":"dict",path:`\\${t}`,name:t,names:[...e.replace(`${rootPath}\\src\\views`,"").split("\\").filter(Boolean),t],fullPath:n}})),o}function dataType(e){let t=Object.prototype.toString.call(e).split(" ")[1];return t.substring(0,t.length-1).toLowerCase()}const ignoreKeys=new Set(["import","webpackChunkName","path","name"]);function conveyFunction(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t)){if(ignoreKeys.has(t))continue;const o=dataType(e[t]);if("function"===o)try{let o=e[t].toString().match(/\{([\s\S]*)\}/);const n=o&&o[1]?o[1]:"";o=e[t].toString().match(/\(([^)]*)\) (\{|=>)/);const r=o&&o[1]?o[1]:"";e[t]=`$$$function(${r}) { ${n} } $$$`.replace(/\r\n/g,"\n")}catch(e){console.log(e)}else"object"===o&&conveyFunction(e[t])}}function importCode(e,t,o,n){return n?`$$$() => import( /* webpackChunkName: '${n}' */ '${o.importPrefix}/${e.length?e.join("/")+"/":""}${"<dictName>"===o.fileName?`${t}.vue`:"index"}.vue')$$$`:`$$$() => import('${o.importPrefix}/${e.length?e.join("/")+"/":""}${"<dictName>"===o.fileName?`${t}.vue`:"index"}.vue')$$$`}function getRouterConfig(content){const matches=[];let match;const reg=/<router>([\s\S]*?)<\/router>/g;for(;null!==(match=reg.exec(content));)matches.push(match[1]);if(matches.length){const params=matches.map((match=>eval(`(function(){return {${match}}})()`)));return params}return null}async function generateRouterConfig(e,t,o,n){let r=null;if(e){r=[];for(const i of e){conveyFunction(i);const e=i.webpackChunkName;i.webpackChunkName&&delete i.webpackChunkName,r.push({...t,...i,component:importCode(o.names,o.name,n,e)})}}return r}function isRegExp(e){return"[object RegExp]"===Object.prototype.toString.call(e)}async function readFileContent(e,t){try{const o=await fs.promises.readFile(`${e.fullPath}\\${"<dictName>"===t.fileName?e.name:"index"}.vue`,"utf-8");return getRouterConfig(o)}catch(e){console.log(e,"error")}}async function readDictContent(e,t){const o=getFilesInfo(e.fullPath);if("{}"===JSON.stringify(o))return null;let n=null;if(o.hasOwnProperty("<dictName>"===t.fileName?`${e.name}.vue`:"index.vue")){const o={path:e.names.length?`/${e.names.join("/")}`:`/${e.name}`},r=await readFileContent(e,t);if(r){const i=await generateRouterConfig(r,o,e,t);i&&(n=[...i])}}e:for(const r in o){if(o["<dictName>"===t.fileName?`${e.name}.vue`:"index.vue"]===r)continue;if("file"===o[r].type)continue;for(const e of t.ignoreFolder)if("string"==typeof e||isRegExp(e)){if("string"==typeof e&&e===o[r].name)continue e;if(isRegExp(e)&&e.test(o[r].name))continue e}const i=await readDictContent(o[r],t);if(n)for(const e of n)"string"!=typeof e&&(e.children||(e.children=[]),i&&e.children.push(...i));else n=i}return n}function checkImportOption(e){return!(!Object.prototype.hasOwnProperty.call(e,"name")||"string"!=typeof e.name)&&((!Object.prototype.hasOwnProperty.call(e,"default")||"boolean"==typeof e.default)&&(!Object.prototype.hasOwnProperty.call(e,"alias")||"string"==typeof e.alias))}function getImportCode(e){const t=[];if(!e)return"";for(const o in e)if(Object.prototype.hasOwnProperty.call(e,o)){const n=[];let r="";for(const[t,i]of e[o])if("string"===dataType(i))n.push(i);else if("object"===dataType(i)){if(!checkImportOption(i))continue;i.default?r=i.name:n.push(i.alias?`${i.name} as ${i.alias}`:i.name)}t.push(`import ${r}${n.length&&""!==r?",":""} ${n.length?`{ ${n.join(",")} }`:""} from "${o}";`)}return t.join("")}function mergeImportOption(e,t){for(const o in e)if(Object.prototype.hasOwnProperty.call(e,o)){if("array"!==dataType(e[o]))continue;Object.prototype.hasOwnProperty.call(t,o)||(t[o]=new Map);for(const n of e[o])"string"==typeof n?t[o].set(n,n):"object"===dataType(n)&&t[o].set(n.name,n)}}let outputPath=null;async function checkOutputPath(e){const t=e.split("/").filter((e=>Boolean(e)));t.pop();let o=rootPath;for(const e of t){o+=`//${e}`;try{await fs.promises.access(o)}catch(e){await fs.promises.mkdir(o)}}}async function outerRouterOptionHandle(e,t){let o="";if(!outputPath){checkOutputPath(t);const e=t.split("/").filter((e=>Boolean(e)));o=e.pop(),outputPath=e.join("//")+"//"}const n=new Map,r=new Map,i=o.split(".")[0];n.set(i,[]),r.set(i,{});for(let t=0;t<e.length;t++)if(Object.prototype.hasOwnProperty.call(e[t],"module")){const o=e[t].module;delete e[t].module,"object"===dataType(e[t].import)&&(r.has(o)||r.set(o,{}),mergeImportOption(e[t].import,r.get(o)),delete e[t].import),await innerRouterOptionHandle(e[t],o,r,n),e[t]=`$$$${o}$$$`,n.get(i).push(`import ${e[t].replace(/\$\$\$/g,"")} from "./${e[t].replace(/\$\$\$/g,"")}"`)}else"object"===dataType(e[t].import)&&(mergeImportOption(e[t].import,r.get(i)),delete e[t].import),await innerRouterOptionHandle(e[t],i,r,n);const a=getImportCode(r.get(i)),c=JSON.stringify(e).replace(/"\$\$\$|\$\$\$"|\$\$\$/g,"").replace(/\\n/g,"\n"),s=await prettier.format(generateRouterTemplate(c,a,n.get(i).join("\n")),{parser:"babel"});fs.promises.writeFile(`${rootPath}//${outputPath}//${o}`,s)}async function innerRouterOptionHandle(e,t,o,n){if(n.has(t)||n.set(t,[]),o.has(t)||o.set(t,{}),e.children)for(let r=0;r<e.children.length;r++)if(Object.prototype.hasOwnProperty.call(e.children[r],"module")&&"string"==typeof e.children[r].module){const i=e.children[r].module;delete e.children[r].module,"object"===dataType(e.children[r].import)&&(o.has(i)||o.set(i,{}),mergeImportOption(e.children[r].import,o.get(i)),delete e.children[r].import),await innerRouterOptionHandle(e.children[r],i,o,n),e.children[r]=`$$$${i}$$$`,n.get(t).push(`import ${e.children[r].replace(/\$\$\$/g,"")} from "./${e.children[r].replace(/\$\$\$/g,"")}"`)}else"object"===dataType(e.children[r].import)&&(o.has(t)||o.set(t,{}),mergeImportOption(e.children[r].import,o.get(t)),delete e.children[r].import),await innerRouterOptionHandle(e.children[r],t,o,n);e=JSON.stringify(e).replace(/"\$\$\$|\$\$\$"|\$\$\$/g,"").replace(/\\n/g,"\n");const r=getImportCode(o.get(t)),i=await prettier.format(generateRouterTemplate(e,r,n.get(t).join("\n")),{parser:"babel"});fs.promises.writeFile(`${rootPath}//${outputPath}//${t}.js`,i)}function generateRouterTemplate(e,t,o){return`\n${o}\n${t}\nexport default ${e}  \n  `}let customConfig=null;try{customConfig=require(`${process.cwd()}\\router.config.js`)}catch(e){console.log(colors$1(["white","redBG"],"the router.config.js is no exist"))}!function(){if(!customConfig)return;const e=Date.now(),t={entry:"/src/views",output:"/src/router/router.js",importPrefix:"@/src/views",ignoreFolder:[],fileName:"index",...customConfig},o=process.cwd(),n=t.entry.split("/").filter(Boolean).join("\\");fs.existsSync(`${o}\\${n}`)?async function(){const r=getFilesInfo(`${o}\\${n}`),i=[];for(const e in r)if(r.hasOwnProperty(e)&&"dict"===r[e].type){const o=await readDictContent(r[e],t);o&&i.push(...o)}await outerRouterOptionHandle(i,t.output),console.log(colors$1(["white","greenBG"],`router file generation successful! (Time-consuming: ${Date.now()-e}ms)`))}():console.log(colors$1(["white","redBG"],"the entry folder is no exist"))}();
